generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  walletAddress String   @unique
  farcasterId   String?  @unique
  farcasterHandle String? // Feature 10: Social
  farcasterLinkedAt DateTime?
  
  xUserId       String?  @unique // Feature 10: Social
  xHandle       String?
  xLinkedAt     DateTime?

  createdAt     DateTime @default(now())

  // Referral System
  referralPointsTotal      Float @default(0)
  referralRewardsClaimable Float @default(0)
  referralRewardsClaimed   Float @default(0)

  invites   Invite[]
  referrals Referral[] @relation("Referrer")
  referred  Referral?  @relation("Referee")

  // Feature 6: Last Seen
  // Feature 6: Last Seen
  lastSeenAt DateTime?
  shares     Int       @default(0) // Added for Feature 8 title calc
  rep        Int       @default(0) // Feature 10: Reputation
  questProgress UserQuestProgress[]
  pendingShares PendingShare[]

  // Feature 9: Clan System V1
  clanMembership ClanMember?
  ownedClan      Clan?       @relation("ClanOwner")

  // Legacy Cartel Referrals
  legacyReferralsAsReferee CartelReferral? @relation("LegacyCartelReferee")
  legacyReferralsAsReferrer CartelReferral[] @relation("LegacyCartelReferrer")
}

// ... existing models ...

// --- CLAN SYSTEM V1 ---

model Clan {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  tag         String
  description String?
  logoUrl     String?

  ownerId     String   @unique
  owner       User     @relation("ClanOwner", fields: [ownerId], references: [id])

  members     ClanMember[]

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
}

model ClanMember {
  id        String   @id @default(uuid())
  clanId    String
  clan      Clan     @relation(fields: [clanId], references: [id])

  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])

  role      ClanRole @default(MEMBER)
  joinedAt  DateTime @default(now())

  @@index([clanId])
  @@index([userId])
}

enum ClanRole {
  OWNER
  OFFICER
  MEMBER
}


model CartelReferral {
  id              String   @id @default(uuid())
  userAddress     String   @unique
  user            User     @relation("LegacyCartelReferee", fields: [userAddress], references: [walletAddress])
  referrerAddress String
  referrer        User     @relation("LegacyCartelReferrer", fields: [referrerAddress], references: [walletAddress])
  season          Int      @default(1)
  joinedAt        DateTime @default(now())

  @@index([referrerAddress])
}

model Invite {
  id        String   @id @default(uuid())
  code      String   @unique
  creatorId String?
  creator   User?    @relation(fields: [creatorId], references: [id])
  status    String   @default("unused") // unused, used
  type      String   @default("standard") // founder, standard
  maxUses   Int      @default(1)
  usedCount Int      @default(0)
  createdAt DateTime @default(now())

  referral Referral?
}

model Referral {
  id         String   @id @default(uuid())
  referrerId String
  referrer   User     @relation("Referrer", fields: [referrerId], references: [id])
  refereeId  String   @unique
  referee    User     @relation("Referee", fields: [refereeId], references: [id])
  inviteId   String   @unique
  invite     Invite   @relation(fields: [inviteId], references: [id])
  joinedAt   DateTime @default(now())

  // Tracking Metrics
  totalFeesPaidByReferee          Float   @default(0)
  totalProfitShareEarnedByReferee Float   @default(0)
  referralPoints                  Float   @default(0)
  isRewardable                    Boolean @default(true)
}

model CartelEvent {
  id                String      @id @default(uuid())
  txHash            String      @unique
  blockNumber       Int
  timestamp         DateTime
  type              String // RAID, HIGH_STAKES_RAID, RETIRE
  attacker          String?
  target            String?
  user              String? // For RETIRE
  stolenShares      Float?
  selfPenaltyShares Float?
  feePaid           Float?   /// @deprecated Use RevenueTransaction table instead
  payout            Float?
  processed         Boolean     @default(false)
  createdAt         DateTime    @default(now())
  news              CartelNews?

  @@index([timestamp(sort: Desc)])
}

model CartelNews {
  id             String      @id @default(uuid())
  eventId        String      @unique
  event          CartelEvent @relation(fields: [eventId], references: [id])
  type           String // RAID, HIGH_STAKES_RAID, RETIRE
  headline       String
  timestamp      DateTime
  attacker       String?
  target         String?
  user           String?
  importance     Int         @default(1)
  postedToSocial Boolean     @default(false)
  txHash         String?
  createdAt      DateTime    @default(now())

  @@index([timestamp(sort: Desc)])
}

// --- QUEST SYSTEM ---

enum QuestCategory {
  SOCIAL
  GAMEPLAY
  REFERRAL
  SYSTEM
}

enum QuestFrequency {
  DAILY
  WEEKLY
  SEASONAL
  ONE_TIME
}

model Quest {
  id              String         @id @default(uuid())
  slug            String         @unique
  title           String
  description     String
  category        QuestCategory
  frequency       QuestFrequency
  rewardRep       Int            @default(0)
  rewardShares    Int            @default(0)
  maxCompletions  Int            @default(1)
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  progress        UserQuestProgress[]
}

model UserQuestProgress {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  questId         String
  quest           Quest     @relation(fields: [questId], references: [id])
  completedCount  Int       @default(0)
  lastResetAt     DateTime  @default(now())
  lastCompletedAt DateTime?

  @@unique([userId, questId])
}

// --- SHARE REWARDS & ANTI-ABUSE ---

enum ShareStatus {
  PENDING
  APPROVED
  MINTED
  REJECTED
}

model PendingShare {
  id        String      @id @default(uuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id])
  amount    Int
  reason    String
  status    ShareStatus @default(PENDING)
  txHash    String?
  createdAt DateTime    @default(now())

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model FraudEvent {
  id        String   @id @default(uuid())
  userId    String?
  reason    String
  details   String?
  createdAt DateTime @default(now())

  @@index([userId])
}

model NotificationToken {
  id        String   @id @default(uuid())
  fid       String
  token     String   @unique
  url       String
  createdAt DateTime @default(now())
  
  @@unique([fid, token])
  @@index([fid])
}
// --- REVENUE SYSTEM V1 (EXPLICIT) ---

model RevenueTransaction {
  id        String      @id @default(cuid())
  txHash    String      @unique
  amount    Float       // Raw USDC amount (e.g. 0.005)
  type      RevenueType
  actor     String      // Wallet Address
  createdAt DateTime    @default(now())

  @@index([createdAt])
}

enum RevenueType {
  RAID
  HIGH_STAKES
}

// --- QUEST SYSTEM V2 (EVENT DRIVEN) ---

model QuestEvent {
  id        String   @id @default(uuid())
  type      String   // RAID | JOIN | CLAIM | REFER
  actor     String   // wallet address
  data      Json
  processed Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([type, processed])
}

model QuestProgressV2 {
  id           String   @id @default(uuid())
  userId       String
  questId      String
  seasonId     Int
  currentCount Int
  completed    Boolean @default(false)
  claimed      Boolean @default(false)

  @@unique([userId, questId, seasonId])
}

model Season {
  id        Int      @id @default(autoincrement())
  startAt   DateTime
  endAt     DateTime
  active    Boolean
}

model AgentSettings {
  id           String   @id @default(uuid())
  userAddress  String   @unique
  enabled      Boolean  @default(false)
  strategy     String   @default("conservative")
  budget       Float    @default(0)
  maxShareRisk Float    @default(5)
  delegation   Json?
  lastRun      DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}


